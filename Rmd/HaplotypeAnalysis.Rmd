---
title: "Getting Haplotypes"
author: "Bruce Cochrane"
date: "October 6, 2016"
output: html_document
---

### Load and process ped files
```{r}
#message("Select PED file")
#dat.ped <- read.table(file.choose(),sep="\t",stringsAsFactors = FALSE) #read ped file
#message("Select INFO file")
#dat.map <-read.table(file.choose(),stringsAsFactors = FALSE) # read info file
dat.ped <- read.table("./Data/lct.yri.ped.txt",sep="\t",stringsAsFactors = FALSE)
dat.map <-read.table("./Data/lct.yri.info",stringsAsFactors = FALSE)
dat.gen <-dat.ped[,7:ncol(dat.ped)] #remove superfluous columns
```

Note that dat.gem should have the same number of variables as dat.map has number of rows.

### Get Tag SNPs

```{r}
#This will get tag files from disk (generated by haploview)
message("Select Tag SNP file")
#tags <-read.table(file.choose(),stringsAsFactors = FALSE)
tags <-read.table("./Data/lct.yri.tags",stringsAsFactors = FALSE)
tags <-as.vector(tags)
```

### Filter by tags

```{r}
n.tags <-which(dat.map$V1 %in% tags[,1])
dat.hap <- dat.gen[,n.tags]
map.hap <-dat.map[n.tags,1]
```

### Prepping for haplo.em

Need to split the columns of the data derived from the ped file and convert from AGCT to 1234.  Function to do so (add to VcfFunctions if it works)  For whatever reason, it seems to work as two functions

```{r}
genosplit  <-function(dat){
  df <-sapply(dat,strsplit," ")
unlist(df)
}
```

```{r}
baseconv <-function(temp){  
  temp.n <-gsub("A",1,temp)
temp.n <- gsub("G",2,temp.n)
temp.n <- gsub("C",3,temp.n)
temp.n <- gsub("T",4,temp.n)
temp.n <-apply(temp.n,1,as.numeric)
temp.n
}
```

```{r}
dat.em <-apply(dat.hap,1,genosplit)
dat.em <-baseconv(dat.em)
dat.em[1:10,1:10]
```

So actually we might be able to combine the functions, but we'll leave them separate for now

### Do haplotype inference

```{r}
library(haplo.stats)
out.em <-haplo.em(dat.em,locus.label = map.hap)
```

And now we have the output!

```{r}
barplot(out.em$hap.prob)
```

Cool little online haplotype inference program - bad news is that it only takes 30 SNPs at a time, but that may be ok for class purposes

http://analysistools.nci.nih.gov/LDlink/

Will output list of haplotypes with numbers as text file.  Could easily use as input for a Ewens demo.

### From LDlink

```{r}
haps <-read.table("./Data/ceu.lct.haplo.txt", sep="\t", header=TRUE,stringsAsFactors = FALSE)
```

```{r}
image(1:ncol(dat.em),1:nrow(dat.em),t(dat.em),xlab="position",ylab="Haplotype",col=c("darkgreen","yellow","darkblue","red"))
```

Yay!  Need to do this again with Yri.  Also, need to extract the haplotypes from the output of haplo.em

```{r}
out.hap <-out.em$haplotype
head(out.hap)
```
That actually looks pretty good - has snps in columns and haplotypes in rows.  Now need to look at duplicateds

```{r}
length(which(duplicated(dat.em))==TRUE)
```


```{r}
out.hap.mat <-(as.matrix(out.hap))
out.hap.mat.n <-apply(out.hap.mat,1,as.numeric)
par(xpd=TRUE)
image(1:70,1:61,(out.hap.mat.n),xlab="position",ylab="Haplotype",col=c("darkgreen","yellow","darkblue","red"))

legend(0,-3,c("A","G","C","T"),fill=c("darkgreen","yellow","darkblue","red"),cex=.8)
```

```{r}
barplot(out.em$hap.prob)
```
```{r}
k <-length(out.em$hap.prob)
f <-fhat(out.em$hap.prob)
n <-70
Ewens(n,k,f)
```

